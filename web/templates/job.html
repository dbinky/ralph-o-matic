{{define "title"}}Job #{{.Job.ID}} - Ralph-o-matic{{end}}

{{define "content"}}
<div style="margin-bottom: 20px;">
    <a href="/" style="color: #888; text-decoration: none;">&larr; Back to Dashboard</a>
</div>

<div class="job-card {{.Job.Status}}" style="margin-bottom: 30px;">
    <div class="job-header">
        <div>
            <span class="job-id">#{{.Job.ID}}</span>
            <span class="job-branch">{{.Job.Branch}}</span>
        </div>
        <span class="badge">{{.Job.Status | upper}}</span>
    </div>

    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0;">
        <div>
            <div style="color: #888; font-size: 0.75rem; text-transform: uppercase;">Iteration</div>
            <div style="font-size: 1.5rem;">{{.Job.Iteration}}/{{.Job.MaxIterations}}</div>
        </div>
        <div>
            <div style="color: #888; font-size: 0.75rem; text-transform: uppercase;">Priority</div>
            <div class="priority-{{.Job.Priority}}">{{.Job.Priority}}</div>
        </div>
        <div>
            <div style="color: #888; font-size: 0.75rem; text-transform: uppercase;">Started</div>
            <div>{{if .Job.StartedAt}}{{.Job.StartedAt | timeago}}{{else}}Not started{{end}}</div>
        </div>
        <div>
            <div style="color: #888; font-size: 0.75rem; text-transform: uppercase;">Duration</div>
            <div>{{.Job.Duration | duration}}</div>
        </div>
    </div>

    {{if .Job.PRURL}}
    <div style="margin: 15px 0;">
        <a href="{{.Job.PRURL}}" target="_blank" class="btn btn-primary">View Pull Request</a>
    </div>
    {{end}}

    <div class="job-actions">
        {{if eq .Job.Status "running"}}
        <button class="btn btn-secondary" onclick="pauseJob({{.Job.ID}})">Pause</button>
        {{end}}
        {{if eq .Job.Status "paused"}}
        <button class="btn btn-primary" onclick="resumeJob({{.Job.ID}})">Resume</button>
        {{end}}
        {{if not .Job.Status.IsTerminal}}
        <button class="btn btn-danger" onclick="cancelJob({{.Job.ID}})">Cancel</button>
        {{end}}
    </div>
</div>

<!-- Prompt -->
<div class="section">
    <div class="section-header">
        <span class="section-title">Prompt</span>
    </div>
    <div style="background: #0d1117; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; font-size: 0.875rem; max-height: 200px; overflow-y: auto;">{{.Job.Prompt}}</div>
</div>

<!-- Logs -->
<div class="section">
    <div class="section-header">
        <span class="section-title">Logs</span>
    </div>
    <div id="logs" style="background: #0d1117; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.75rem; max-height: 400px; overflow-y: auto;">
        {{range .Logs}}
        <div style="margin-bottom: 4px;">
            <span style="color: #888;">[iter {{.Iteration}}]</span>
            <span>{{.Message}}</span>
        </div>
        {{else}}
        <div style="color: #666;">No logs yet</div>
        {{end}}
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
    async function pauseJob(id) {
        await fetch(`/api/jobs/${id}/pause`, { method: 'POST' });
        location.reload();
    }

    async function resumeJob(id) {
        await fetch(`/api/jobs/${id}/resume`, { method: 'POST' });
        location.reload();
    }

    async function cancelJob(id) {
        if (confirm('Cancel this job?')) {
            await fetch(`/api/jobs/${id}`, { method: 'DELETE' });
            location.href = '/';
        }
    }

    // Auto-scroll logs
    const logsDiv = document.getElementById('logs');
    logsDiv.scrollTop = logsDiv.scrollHeight;

    // SSE for live log updates
    const evtSource = new EventSource('/api/jobs/{{.Job.ID}}/events');
    evtSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'log') {
            const logLine = document.createElement('div');
            logLine.style.marginBottom = '4px';
            logLine.innerHTML = `<span style="color: #888;">[iter ${data.iteration}]</span> <span>${data.message}</span>`;
            logsDiv.appendChild(logLine);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
    };
</script>
{{end}}
